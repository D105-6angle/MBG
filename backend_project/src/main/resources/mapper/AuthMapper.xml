<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.model.mapper.auth.AuthMapper">

    <!-- 사용자 조회 -->
    <select id="findByProviderId" parameterType="string" resultMap="UserResultMap">
        SELECT u.user_id, u.code_id, u.name, u.nickname, u.email, u.is_deleted, u.created_at
        FROM users u LEFT JOIN social_accounts s ON u.user_id = s.user_id
        WHERE s.provider_id = #{providerId}
    </select>

    <!-- 내부 중첩 클래스 참조에는 '.' 대신 '$' 사용 -->
    <insert id="insertUser" parameterType="com.ssafy.controller.auth.AuthRequest$RegistrationUserData" useGeneratedKeys="true" keyProperty="userId" keyColumn="user_id">
        INSERT INTO users (code_id, name, nickname, email)
        VALUES (#{codeId}, #{name}, #{nickname}, #{email})
    </insert>

    <insert id="insertSocial" parameterType="com.ssafy.model.entity.Social">
        INSERT INTO social_accounts(user_id, code_id, provider_id, access_token, refresh_token)
        VALUES(#{userId}, #{codeId}, #{providerId}, #{accessToken}, #{refreshToken})
    </insert>

    <resultMap id="UserResultMap" type="com.ssafy.model.entity.User">
       <id property="userId" column="user_id"/>
        <result property="codeId" column="code_id"/>
        <result property="name" column="name"/>
        <result property="nickname" column="nickname"/>
        <result property="email" column="email"/>
        <result property="isDeleted" column="is_deleted"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>
</mapper>
